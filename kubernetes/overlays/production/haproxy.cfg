global
    maxconn 50000
    log /dev/log local0
    user haproxy
    group haproxy
    daemon
    ssl-default-bind-options no-sslv3 no-tlsv10 no-tlsv11
    ssl-default-bind-ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256
    tune.ssl.default-dh-param 2048

defaults
    mode http
    log global
    option httplog
    option dontlognull
    option http-server-close
    option redispatch
    retries 3
    timeout http-request 10s
    timeout queue 1m
    timeout connect 10s
    timeout client 1m
    timeout server 1m

frontend http-in
    bind *:80
    bind *:443 ssl crt /etc/ssl/certs/cert.pem
    redirect scheme https code 301 if !{ ssl_fc }
    
    # Rate limiting
    stick-table type ip size 100k expire 30s store http_req_rate(10s)
    http-request track-sc0 src
    http-request deny deny_status 429 if { sc_http_req_rate(0) gt 100 }
    
    # ACLs for path-based routing
    acl is_api path_beg /api/
    acl is_websocket hdr(Upgrade) -i WebSocket
    
    use_backend websocket-backend if is_websocket
    use_backend api-backend if is_api
    default_backend www-backend

backend api-backend
    balance roundrobin
    option httpchk GET /health
    http-check expect status 200
    cookie SERVERID insert indirect nocache
    server api1 api1:8000 check cookie s1
    server api2 api2:8000 check cookie s2
    server api3 api3:8000 check cookie s3

backend websocket-backend
    balance source
    option httpchk GET /health
    http-check expect status 200
    server ws1 ws1:8000 check
    server ws2 ws2:8000 check